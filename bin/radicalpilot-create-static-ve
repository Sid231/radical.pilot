#!/bin/sh

scriptname="radical-pilot-create-static-ve"

reqs="pymongo==2.8 python-hostlist netifaces==0.10.4 setproctitle ntplib pyzmq"
reqs="$reqs apache-libcloud colorama backports.ssl-match-hostname msgpack-python"
reqs="$reqs future"

setuptools="setuptools==0.6c11"
pip="pip==1.4.1"

# ------------------------------------------------------------------------------
#
help(){

    err="$1"
    ret=0
    
    if ! test -z "$err"
    then
        ret=1
        printf "\n    ERROR: $err\n"
    fi

    cat <<EOT

    usage: $0 -h
    usage: $0 <target>

    This script creates a virtualenv at the given target location.  That
    virtualenv should be suitable to be used as static VE for a radical.pilot
    target resource, and can be specified in a resource configuration for RP.

EOT
    exit $ret
}


# ------------------------------------------------------------------------------
#
progress(){

  while read X
  do
    echo -n .
  done
  echo
}

# ------------------------------------------------------------------------------
#
prefix=$1

if test "$prefix" = "-h"
then
    help 
fi

if test -z "$prefix"
then
    help "missing target"
fi

# We don't want to overwrite VE's -- the hack to get the namespace import in
# place is too invasive to be applied to an existing VE.
if test -e "$prefix"
then
    help "target '$prefix' exists"
fi

# Ensure we install in an absolute path -- pip seems to like that better...
case $prefix in
    /*)
        ;;
    *)
        prefix="`pwd`/$prefix"
        ;;
esac


# create the ve, install bare necessities
mkdir -p "$prefix"

echo -n "create  virtualenv"
stdbuf -oL virtualenv "$prefix" | progress
.          "$prefix"/bin/activate

# echo "--- update  setuptools"
# pip install --upgrade $setuptools || exit 1
# echo "--- update  pip"
# pip install --upgrade $pip        || exit 1

for req in $reqs
do
    echo -n "install $req "
    stdbuf -oL pip install --upgrade $req | progress   || exit 1
done

echo

